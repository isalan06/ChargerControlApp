@{
    ViewData["Title"] = "Motor";
}
<div class="text-center">
    <h1 class="display-4">馬達操作</h1>
    <div class="motor-tabs">
        <button class="motor-tab-btn active" onclick="showTab('manual')">手動</button>
        <button class="motor-tab-btn" onclick="showTab('semiAuto')">半自動</button>
        <button class="motor-tab-btn" onclick="showTab('settings')">設定</button>
    </div>
    <div id="manualTab" class="motor-tab-content">
        <div class="motors-row" id="motorsRow"></div>
        <div class="motors-actions-flex" id="motorsActions"></div>
    </div>
    <div id="semiAutoTab" class="motor-tab-content" style="display:none;">
        <div class="semi-auto-content d-flex" style="gap:24px; align-items:flex-start;">
            <!-- 左側基本操作區 -->
            <div class="col-3" style="min-width:420px;">
                <div class="card mb-3">
                    <div class="card-header">
                        基本操作區
                    </div>
                    <div class="card-body">
                        <form>
                            <button type="button" id="servoOnBtn" class="btn btn-success w-100 mb-2">伺服啟動</button>
                        </form>
                        <form>
                            <button type="button" id="servoOffBtn" class="btn btn-warning w-100 mb-2">伺服關閉</button>
                        </form>
                        <form>
                            <button type="button" id="allStopBtn" class="btn btn-danger w-100">動作停止</button>
                        </form>
                        <form>
                            <button type="button" id="stopProcedureBtn" class="btn btn-danger w-100 mt-2">流程停止</button>
                        </form>
                        <div class="mt-2">
                            <span>程序執行狀態：</span>
                            <span id="procedureRunningStatus" style="font-weight:bold;">-</span>
                        </div>
                        <div class="mt-2">
                            <span>錯誤碼：</span>
                            <span id="errorCode" style="font-weight:bold;">-</span>
                        </div>
                        <div class="mt-2">
                            <span>錯誤訊息：</span>
                            <div id="errorMessage" style="border:1px solid #ccc; min-height:80px; padding:8px; background:#f9f9f9; white-space:pre-wrap; font-family:Consolas, monospace;">
                                -
                            </div>
                            <button type="button" id="clearErrorBtn" class="btn btn-secondary btn-sm">清除</button>
                        </div>
                    </div>
                </div>
                <div class="card mt-3">
                    <div class="card-header">原點復歸</div>
                    <div class="card-body">
                        <span id="homeFinishedStatus" style="font-weight:bold;">-</span>
                        <br />
                        <span id="homeProcedureCaseStatus" style="font-weight:bold; color:#007bff;">程序編號：-</span>
                        <br />
                        <button id="startHomeProcedureBtn" class="btn btn-primary mt-2">原點復歸</button>
                    </div>
                </div>
            </div>
            <div style="min-width:420px;">
                <div class="card mb-3">
                    <div class="card-header">流程狀態區</div>
                    <div class="card-body">
                        <div>
                            <span>狀態訊息</span>
                            <div id="procedureStatusArea" style="border:1px solid #ccc; min-height:80px; padding:8px; background:#f9f9f9; white-space:pre-wrap; font-family:Consolas, monospace;">
                                -
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 旋轉動作區 (放在流程狀態區下方) -->
                <div class="card mb-3">
                    <div class="card-header">旋轉動作區</div>
                    <div class="card-body">
                        <div style="margin-bottom:12px; font-weight:bold;">參數</div>
                        <div style="display:flex; align-items:center; gap:12px;">
                            <span>R-Target:</span>
                            <select id="rTargetCombo" class="form-select" style="width:120px;">
                                <option value="0">R0</option>
                                <option value="1">R1</option>
                                <option value="2">R2</option>
                            </select>
                        </div>
                        <!-- 旋轉動作流程啟動按鈕 -->
                        <div style="margin-top:20px;">
                            <button type="button" id="startRotateProcedureBtn" class="btn btn-primary w-100">
                                旋轉動作流程啟動
                            </button>
                        </div>
                    </div>
                </div>
                <!-- 車輛電池交換區 (新增於旋轉動作區下方) -->
                <div class="card mb-3">
                    <div class="card-header">車輛電池交換區</div>
                    <div class="card-body">
                        <div style="display:flex; gap:16px;">
                            <button type="button" id="startTakeCarBatteryProcedureBtn" class="btn btn-warning w-100">
                                從車輛取電池
                            </button>
                            <button type="button" id="startPlaceCarBatteryProcedureBtn" class="btn btn-success w-100">
                                電池放置到車輛
                            </button>
                        </div>
                    </div>
                </div>
                <!-- 馬達可移動訊息區 -->
                <div class="card mb-3">
                    <div class="card-header">馬達可移動訊息區 </div>
                    <div class="card-body">
                        <div>
                            <span>旋轉軸</span>
                            <div id="rotateAxesCanMoveMessage" style="border:1px solid #ccc; min-height:80px; padding:8px; background:#f9f9f9; white-space:pre-wrap; font-family:Consolas, monospace;">
                                
                            </div>
                        </div>
                        <div>
                            <span>Y軸</span>
                            <div id="yAxesCanMoveMessage" style="border:1px solid #ccc; min-height:80px; padding:8px; background:#f9f9f9; white-space:pre-wrap; font-family:Consolas, monospace;">
                            </div>
                        </div>
                        <div>
                            <span>Z軸</span>
                            <div id="zAxesCanMoveMessage" style="border:1px solid #ccc; min-height:80px; padding:8px; background:#f9f9f9; white-space:pre-wrap; font-family:Consolas, monospace;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右側狀態方框 -->
            <div style="min-width:420px;">
                <!-- Slot電池放置流程方框（新增） -->
                <div class="card mb-3" style="min-width:320px;">
                    <div class="card-header">Slot電池放置流程</div>
                    <div class="card-body">
                        <div style="margin-bottom:12px;">
                            <label for="slotNoInput" style="font-weight:bold;">Slot編號：</label>
                            <select id="slotNoInput" class="form-control" style="width:100px; display:inline-block;">
                                <option value="4">1</option>
                                <option value="6">2</option>
                                <option value="8">3</option>
                                <option value="10">4</option>
                                <option value="12">5</option>
                                <option value="14">6</option>
                                <option value="16">7</option>
                                <option value="18">8</option>
                            </select>
                        </div>
                        <div style="display:flex; gap:12px;">
                            <button type="button" id="startPlaceSlotBatteryProcedureBtn" class="btn btn-success w-100">
                                電池放置到Slot
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Slot電池取出流程方框（新增） -->
                <div class="card mb-3" style="min-width:320px;">
                    <div class="card-header">Slot電池取出流程</div>
                    <div class="card-body">
                        <div style="margin-bottom:12px;">
                            <label for="slotNoInputTake" style="font-weight:bold;">Slot編號：</label>
                            <select id="slotNoInputTake" class="form-control" style="width:100px; display:inline-block;">
                                <option value="3">1</option>
                                <option value="5">2</option>
                                <option value="7">3</option>
                                <option value="9">4</option>
                                <option value="11">5</option>
                                <option value="13">6</option>
                                <option value="15">7</option>
                                <option value="17">8</option>
                            </select>
                        </div>
                        <div style="display:flex; gap:12px;">
                            <button type="button" id="startTakeSlotBatteryProcedureBtn" class="btn btn-success w-100">
                                從Slot取出電池
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card mb-3">
                    <div class="card-header">測試程序狀態</div>
                    <div class="card-body">
                        <div>
                            <span>執行中：</span>
                            <span id="testProcedureStatus" style="font-weight:bold; color:#007bff;">-</span>
                        </div>
                        <button type="button" id="stopTestProcedureBtn" class="btn btn-danger mt-3 w-100">Stop Procedure</button>
                        <button type="button" id="startTestProcedureBtn" class="btn btn-primary mt-3 w-100">Test Procedure 1</button>
                    </div>
                </div>
            </div>
            <!-- 右側可放其他內容 -->
            <div style="flex:1;">
                @* 其他 semiAutoTab 內容 *@
            </div>
        </div>
    </div>
    <div id="settingsTab" class="motor-tab-content" style="display:none;">
        <div class="settings-content">
            <h2>參數設定</h2>
            <div class="settings-subtabs">
                <button class="settings-subtab-btn active" onclick="showSettingsSubTab('jogHome')">Jog&Home</button>
                <button class="settings-subtab-btn" onclick="showSettingsSubTab('posVel')">位置&速度</button>
            </div>
            <div id="jogHomeTab" class="settings-subtab-content">
                <h3>Jog&Home 設定</h3>
                <div style="margin-bottom:12px; display:flex; align-items:center; gap:16px;">
                    <div id="motorRadioGroup">
                        <label><input type="radio" name="motorRadio" value="0" checked>馬達1-旋轉軸</label>
                        <label><input type="radio" name="motorRadio" value="1">馬達2-Y軸</label>
                        <label><input type="radio" name="motorRadio" value="2">馬達3-Z軸</label>
                    </div>
                    <button id="jogHomeRefreshBtn" type="button">Refresh</button>
                    <button id="jogHomeSaveBtn" type="button">Save</button>
                </div>
                <table id="jogHomeTable" class="table table-bordered" style="width:100%;text-align:center;">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>參數名</th>
                            <th>數值</th>
                            <th>寫入數值</th>
                            <th>動作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 由 JS 動態產生 -->
                    </tbody>
                </table>
            </div>
            <div id="posVelTab" class="settings-subtab-content" style="display:none;">
                <h3>位置&速度 設定</h3>
                <div style="margin-bottom:12px; display:flex; align-items:center; gap:16px;">
                    <div id="posVelMotorRadioGroup">
                        <label><input type="radio" name="posVelMotorRadio" value="0" checked>馬達1-旋轉軸</label>
                        <label><input type="radio" name="posVelMotorRadio" value="1">馬達2-Y軸</label>
                        <label><input type="radio" name="posVelMotorRadio" value="2">馬達3-Z軸</label>
                    </div>
                    <button id="posVelRefreshBtn" type="button">Refresh</button>
                    <button id="posVelSaveBtn" type="button">Save</button>
                </div>
                <table id="posVelTable" class="table table-bordered" style="width:100%;text-align:center;">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>運轉方式</th>
                            <th>位置</th>
                            <th>位置輸入</th>
                            <th>位置設定</th>
                            <th>速度</th>
                            <th>速度輸入</th>
                            <th>速度設定</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 由 JS 動態產生 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function showTab(tab) {
        document.getElementById('manualTab').style.display = tab === 'manual' ? '' : 'none';
        document.getElementById('semiAutoTab').style.display = tab === 'semiAuto' ? '' : 'none';
        document.getElementById('settingsTab').style.display = tab === 'settings' ? '' : 'none';
        document.querySelectorAll('.motor-tab-btn').forEach(btn => btn.classList.remove('active'));
        if (tab === 'manual')
            document.querySelector('.motor-tab-btn:nth-child(1)').classList.add('active');
        else if (tab === 'semiAuto')
            document.querySelector('.motor-tab-btn:nth-child(2)').classList.add('active');
        else if (tab === 'settings')
            document.querySelector('.motor-tab-btn:nth-child(3)').classList.add('active');
    }

    function showSettingsSubTab(subTab) {
        document.getElementById('jogHomeTab').style.display = subTab === 'jogHome' ? '' : 'none';
        document.getElementById('posVelTab').style.display = subTab === 'posVel' ? '' : 'none';
        document.querySelectorAll('.settings-subtab-btn').forEach(btn => btn.classList.remove('active'));
        if (subTab === 'jogHome')
            document.querySelector('.settings-subtab-btn:nth-child(1)').classList.add('active');
        else if (subTab === 'posVel')
            document.querySelector('.settings-subtab-btn:nth-child(2)').classList.add('active');
    }

    function renderMotorsStatus(data) {
        // 馬達名稱對照表
        const motorNames = {
            0: '旋轉',
            1: 'Y軸',
            2: 'Z軸'
        };
        let html = '';
        data.forEach(m => {
            html += `
            <div class="motor-status-card">
                <div class="card-section-top">
                    <div class="motor-title">馬達 #${m.id} (${motorNames[m.id] ?? '未知'})</div>
                    <div class="motor-title-divider"></div>
                    <div class="section-title section-title-io">IO狀態</div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px; margin-left:12px">
                        <span class="status-light ${m.sOn ? 'on' : 'off'}"></span>
                        <span>伺服</span>
                        <span class="alarm-light ${m.armA ? 'on' : 'off'}"></span>
                        <span>Alarm</span>
                        <span title="${m.errorMessage || ''}">錯誤碼：${m.errorCode}</span>
                    </div>
                    <div class="lights-row">
                        <div class="light-item">
                            <span class="status-light ${m.sysBsy ? 'on' : 'off'}"></span>
                            <span>BUSY</span>
                        </div>
                        <div class="light-item">
                            <span class="status-light ${m.move ? 'on' : 'off'}"></span>
                            <span>MOVE</span>
                        </div>
                        <div class="light-item">
                            <span class="status-light ${m.inPos ? 'on' : 'off'}"></span>
                            <span>IN-POS</span>
                        </div>
                    </div>
                    <div class="lights-row">
                        <div class="light-item">
                            <span class="status-light ${m.stopR ? 'on' : 'off'}"></span>
                            <span>STOP</span>
                        </div>
                        <div class="light-item">
                            <span class="status-light ${m.freeR ? 'on' : 'off'}"></span>
                            <span>FREE</span>
                        </div>
                        <div class="light-item">
                            <span class="status-light ${m.rdyDdOpe ? 'on' : 'off'}"></span>
                            <span>DD</span>
                        </div>
                    </div>
                    <div class="lights-row">
                        <div class="light-item">
                            <span class="status-light ${m.rdyHomeOpe ? 'on' : 'off'}"></span>
                            <span>HOME</span>
                        </div>
                        <div class="light-item">
                            <span class="status-light ${m.rdyFwrvOpe ? 'on' : 'off'}"></span>
                            <span>FWRV</span>
                        </div>
                        <div class="light-item">
                            <span class="status-light ${m.rdySdOpe ? 'on' : 'off'}"></span>
                            <span>SD</span>
                        </div>
                    </div>
                    <div class="lights-row">
                        <div class="light-item">
                            <span class="status-light ${m.r0R ? 'on' : 'off'}"></span>
                            <span>R0R</span>
                        </div>
                        <div class="light-item">
                            <span class="status-light ${m.r1R ? 'on' : 'off'}"></span>
                            <span>R1R</span>
                        </div>
                        <div class="light-item">
                            <span class="status-light ${m.homeEnd ? 'on' : 'off'}"></span>
                            <span>H-END</span>
                        </div>
                    </div>
                </div>
                <div class="card-divider"></div>
                <div class="card-section card-section-bottom">
                    <div class="section-title">數據</div>
                    <div class="pos-vel-row">
                        <div>位置：${m.posActual}</div>
                        <div style="flex:1; text-align:center;">速度：${m.velActual}</div>
                    </div>
                    <div class="opdata-list">
                        <div class="opdata-row">
                            <div class="opdata-item">選擇資料編號：${m.opData_IdSelect}</div>
                            <div class="opdata-item">運轉資料編號：${m.opData_IdOp}</div>
                        </div>
                        <div class="opdata-row">
                            <div class="opdata-item">指令位置：${m.opData_Pos_Command}</div>
                            <div class="opdata-item">指令速度：${m.opData_Vel_Command}</div>
                        </div>
                        <div class="opdata-row">
                            <div class="opdata-item">檢測位置：${m.opData_Pos_Actual}</div>
                            <div class="opdata-item">檢測速度：${m.opData_Vel_Actual}</div>
                        </div>
                        <div class="opdata-row">
                            <div class="opdata-item">轉矩監視(%)：${m.trqMonitor}</div>
                            <div class="opdata-item">負載監視(%)：${m.loadMonitor}</div>
                        </div>
                    </div>
                </div>
            </div>
            `;
        });
        document.getElementById('motorsRow').innerHTML = html;
    }

    function renderMotorsActions(data) {
        let html = '';
        data.forEach(m => {
            html += `
            <div class="motor-action-card motor-action-frame">
                <div class="servo-alarm-row">
                    <button type="button" class="toggle-servo-btn" data-id="${m.id}">切換伺服</button>
                    <button type="button"
                        class="alarm-btn"
                        data-id="${m.id}"
                        onmousedown="setAlarm(${m.id}, true)"
                        onmouseup="setAlarm(${m.id}, false)"
                        onmouseleave="setAlarm(${m.id}, false)">
                        Reset Alarm
                    </button>
                </div>
                <div class="action-btn-row">
                    <button type="button"
                        class="action-btn"
                        onmousedown="setHome(${m.id}, true)"
                        onmouseup="setHome(${m.id}, false)"
                        onmouseleave="setHome(${m.id}, false)">
                        HOME
                    </button>
                    <button type="button"
                        class="action-btn"
                        onmousedown="setStop(${m.id}, true)"
                        onmouseup="setStop(${m.id}, false)"
                        onmouseleave="setStop(${m.id}, false)">
                        STOP
                    </button>
                </div>
                <div class="jog-btn-row">
                    <button type="button"
                        class="jog-btn"
                        onmousedown="setJog(${m.id}, 'FW', true)"
                        onmouseup="setJog(${m.id}, 'FW', false)"
                        onmouseleave="setJog(${m.id}, 'FW', false)">
                        FW-JOG
                    </button>
                    <button type="button"
                        class="jog-btn"
                        onmousedown="setJog(${m.id}, 'RV', true)"
                        onmouseup="setJog(${m.id}, 'RV', false)"
                        onmouseleave="setJog(${m.id}, 'RV', false)">
                        RV-JOG
                    </button>
                </div>
                <div class="data-select-row">
                    <span class="data-select-title">位置資料選擇</span>
                    <select class="data-select-combo" onchange="setDataNo_M(${m.id}, this.value)">
                        ${[...Array(20).keys()].map(n => `<option value="${n}" ${m.dataNo == n ? 'selected' : ''}>${n}</option>`).join('')}
                    </select>
                    <button type="button"
                        class="start-btn"
                        onmousedown="setStart(${m.id}, true)"
                        onmouseup="setStart(${m.id}, false)"
                        onmouseleave="setStart(${m.id}, false)"
                        style="margin-left:12px;">
                        MOVE
                    </button>
                </div>
                <div class="data-select-row">
                    <span class="data-select-title">速度選擇</span>
                    <select class="speed-select-combo" onchange="setSpeedDataNo_M(${m.id}, this.value)">
                        <option value="20">10</option>
                        <option value="21">25</option>
                        <option value="22">50</option>
                        <option value="23">100</option>
                        <option value="24">300</option>
                    </select>
                </div>
                <div class="spd-btn-row" style="margin-top:8px; display:flex; gap:12px;">
                    <button type="button"
                        class="jog-btn"
                        onmousedown="setSpd(${m.id}, 'FW', true)"
                        onmouseup="setSpd(${m.id}, 'FW', false)"
                        onmouseleave="setSpd(${m.id}, 'FW', false)">
                        FW-SPD
                    </button>
                    <button type="button"
                        class="jog-btn"
                        onmousedown="setSpd(${m.id}, 'RV', true)"
                        onmouseup="setSpd(${m.id}, 'RV', false)"
                        onmouseleave="setSpd(${m.id}, 'RV', false)">
                        RV-SPD
                    </button>
                    <button type="button"
                        class="set-pos-btn"
                        data-motor-id="${m.id}"
                        style="margin-left:8px;">
                        SET
                    </button>
                </div>
            </div>
            `;
        });
        document.getElementById('motorsActions').innerHTML = html;

        document.querySelectorAll('.toggle-servo-btn').forEach(btn => {
            btn.onclick = function() {
                const motorId = btn.getAttribute('data-id');
                fetch('/Motor/ToggleServo?motorId=' + motorId, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        // 可依需求顯示狀態
                    });
            };
        });

        document.querySelectorAll('.alarm-btn').forEach(btn => {
            btn.onmousedown = function() {
                const motorId = btn.getAttribute('data-id');
                fetch('/Motor/SetAlarm?motorId=' + motorId + '&state=true', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        // 可依需求顯示狀態
                    });
            };
            btn.onmouseup = function() {
                const motorId = btn.getAttribute('data-id');
                fetch('/Motor/SetAlarm?motorId=' + motorId + '&state=false', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        // 可依需求顯示狀態
                    });
            };
            btn.onmouseleave = function() {
                const motorId = btn.getAttribute('data-id');
                fetch('/Motor/SetAlarm?motorId=' + motorId + '&state=false', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        // 可依需求顯示狀態
                    });
            };
        });

        document.querySelectorAll('.action-btn').forEach(btn => {
    if (btn.textContent.trim() === 'HOME') {
        btn.onmousedown = function() {
            const motorId = btn.closest('.motor-action-card').querySelector('.toggle-servo-btn').getAttribute('data-id');
            fetch('/Motor/SetHome?motorId=' + motorId + '&state=true', { method: 'POST' })
                .then(response => response.json());
        };
        btn.onmouseup = function() {
            const motorId = btn.closest('.motor-action-card').querySelector('.toggle-servo-btn').getAttribute('data-id');
            fetch('/Motor/SetHome?motorId=' + motorId + '&state=false', { method: 'POST' })
                .then(response => response.json());
        };
        btn.onmouseleave = function() {
            const motorId = btn.closest('.motor-action-card').querySelector('.toggle-servo-btn').getAttribute('data-id');
            fetch('/Motor/SetHome?motorId=' + motorId + '&state=false', { method: 'POST' })
                .then(response => response.json());
        };
    }
    if (btn.textContent.trim() === 'STOP') {
        btn.onmousedown = function() {
            const motorId = btn.closest('.motor-action-card').querySelector('.toggle-servo-btn').getAttribute('data-id');
            fetch('/Motor/SetStop?motorId=' + motorId + '&state=true', { method: 'POST' })
                .then(response => response.json());
        };
        btn.onmouseup = function() {
            const motorId = btn.closest('.motor-action-card').querySelector('.toggle-servo-btn').getAttribute('data-id');
            fetch('/Motor/SetStop?motorId=' + motorId + '&state=false', { method: 'POST' })
                .then(response => response.json());
        };
        btn.onmouseleave = function() {
            const motorId = btn.closest('.motor-action-card').querySelector('.toggle-servo-btn').getAttribute('data-id');
            fetch('/Motor/SetStop?motorId=' + motorId + '&state=false', { method: 'POST' })
                .then(response => response.json());
        };
    }
});

    // ★★★ JOG radio 事件綁定（放在這裡）★★★
    document.querySelectorAll('.radio-item input[type="radio"]').forEach(radio => {
        radio.onchange = function() {
            const motorId = this.name.replace('jogMode', '');
            const mode = this.value;
            fetch('/Motor/SetJogMode?motorId=' + motorId + '&mode=' + mode, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    // 可依需求顯示狀態
                });
        };
    });

    // JOG 按鈕事件綁定
    document.querySelectorAll('.jog-btn-row .jog-btn').forEach(btn => {
        btn.onmousedown = function() {
            const motorId = btn.closest('.motor-action-card').querySelector('.toggle-servo-btn').getAttribute('data-id');
            const dir = btn.textContent.includes('FW') ? 'FW' : 'RV';
            fetch(`/Motor/SetJog?motorId=${motorId}&dir=${dir}&state=true`, { method: 'POST' })
                .then(response => response.json());
        };
        btn.onmouseup = function() {
            const motorId = btn.closest('.motor-action-card').querySelector('.toggle-servo-btn').getAttribute('data-id');
            const dir = btn.textContent.includes('FW') ? 'FW' : 'RV';
            fetch(`/Motor/SetJog?motorId=${motorId}&dir=${dir}&state=false`, { method: 'POST' })
                .then(response => response.json());
        };
        btn.onmouseleave = function() {
            const motorId = btn.closest('.motor-action-card').querySelector('.toggle-servo-btn').getAttribute('data-id');
            const dir = btn.textContent.includes('FW') ? 'FW' : 'RV';
            fetch(`/Motor/SetJog?motorId=${motorId}&dir=${dir}&state=false`, { method: 'POST' })
                .then(response => response.json());
        };
    });

    // SPD 按鈕事件綁定
    document.querySelectorAll('.spd-btn-row .jog-btn').forEach(btn => {
        btn.onmousedown = function() {
            const card = btn.closest('.motor-action-card');
            const motorId = card.querySelector('.toggle-servo-btn').getAttribute('data-id');
            const dir = btn.textContent.includes('FW') ? 'FW' : 'RV';
            const speedDataNo = card.querySelector('.speed-select-combo').value;
            fetch(`/Motor/SetSpdWithSpeedDataNo?motorId=${motorId}&dir=${dir}&state=true&speedDataNo=${speedDataNo}`, { method: 'POST' })
                .then(response => response.json());
        };
        btn.onmouseup = function() {
            const motorId = btn.closest('.motor-action-card').querySelector('.toggle-servo-btn').getAttribute('data-id');
            const dir = btn.textContent.includes('FW') ? 'FW' : 'RV';
            fetch(`/Motor/SetSpd?motorId=${motorId}&dir=${dir}&state=false`, { method: 'POST' })
                .then(response => response.json());
        };
        btn.onmouseleave = function() {
            const motorId = btn.closest('.motor-action-card').querySelector('.toggle-servo-btn').getAttribute('data-id');
            const dir = btn.textContent.includes('FW') ? 'FW' : 'RV';
            fetch(`/Motor/SetSpd?motorId=${motorId}&dir=${dir}&state=false`, { method: 'POST' })
                .then(response => response.json());
        };
    });

    // 新增 SET 按鈕事件
    document.querySelectorAll('.set-pos-btn').forEach(btn => {
        btn.onclick = function() {
            const card = btn.closest('.motor-action-card');
            const motorId = parseInt(btn.getAttribute('data-motor-id'), 10);
            const posIndex = parseInt(card.querySelector('.data-select-combo').value, 10);

            // 建議直接從 data 取得
            let currentPosition = 0;
            if (typeof data !== 'undefined' && data[motorId]) {
                currentPosition = data[motorId].posActual;
            } else {
                // 從畫面抓（備用）
                const statusCard = document.querySelectorAll('.motor-status-card')[motorId];
                if (statusCard) {
                    const posDiv = statusCard.querySelector('.pos-vel-row div');
                    if (posDiv) {
                        // 這裡用正則抓第一個帶負號的整數
                        const match = posDiv.textContent.match(/-?\d+/);
                        if (match) {
                            currentPosition = Number(match[0]);
                        }
                    }
                }
            }

            fetch('/Motor/SetPosition', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    motorId: motorId,
                    posIndex: posIndex,
                    position: currentPosition
                })
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    alert('位置已寫入');
                } else {
                    alert('寫入失敗');
                }
            });
        }
    });

    document.querySelectorAll('.start-btn').forEach(btn => {
        btn.onmousedown = function() {
            // 取得 card 範圍
            const card = btn.closest('.motor-action-card');
            const motorId = card.querySelector('.toggle-servo-btn').getAttribute('data-id');
            const posIndex = parseInt(card.querySelector('.data-select-combo').value, 10);
            fetch(`/Motor/SetStartWithPos?motorId=${motorId}&state=true&posIndex=${posIndex}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    // 可依需求顯示狀態或提示
                });
        };
        btn.onmouseup = function() {
            const card = btn.closest('.motor-action-card');
            const motorId = card.querySelector('.toggle-servo-btn').getAttribute('data-id');
            fetch(`/Motor/SetStart?motorId=${motorId}&state=false`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    // 可依需求顯示狀態或提示
                });
        };
        btn.onmouseleave = function() {
            const card = btn.closest('.motor-action-card');
            const motorId = card.querySelector('.toggle-servo-btn').getAttribute('data-id');
            fetch(`/Motor/SetStart?motorId=${motorId}&state=false`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    // 可依需求顯示狀態或提示
                });
        };
    });

    document.querySelectorAll('.data-select-combo').forEach(combo => {
    combo.onchange = function() {
        const motorId = combo.closest('.motor-action-card').querySelector('.toggle-servo-btn').getAttribute('data-id');
        const dataNo = combo.value;
        fetch(`/Motor/SetDataNo_M?motorId=${motorId}&dataNo=${dataNo}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                // 可依需求顯示狀態或提示
            });
        };
    });

        // 速度資料選擇 comboBox 綁定
    document.querySelectorAll('.speed-select-combo').forEach(combo => {
        combo.onchange = function() {
            const motorId = combo.closest('.motor-action-card').querySelector('.toggle-servo-btn').getAttribute('data-id');
            const speedDataNo = combo.value;
            fetch(`/Motor/SetSpeedDataNo_M?motorId=${motorId}&speedDataNo=${speedDataNo}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    // 可依需求顯示狀態或提示
                });
        };
    });
    

    }

    function updateMotorsStatus() {
        fetch('/Motor/GetMotorsStatus')
            .then(response => response.json())
            .then(data => {
                renderMotorsStatus(data);
            });
    }

    fetch('/Motor/GetMotorsStatus')
        .then(response => response.json())
        .then(data => {
            renderMotorsActions(data);
        });

    

    setInterval(updateMotorsStatus, 2000);
    updateMotorsStatus();
</script>

<script>
    const jogHomeParamNames = [
        "Jog移動量", "Jog運轉速度", "Jog加減速", "Jog起動速度", "Jog運轉速度高", "Jog Home平滑時間常數", "Jog Home轉矩限制值", "Home方式",
        "Home開始方向", "Home加減速", "Home起動速度", "Home運轉速度", "Home原點檢測速度", "Home SLIT 檢測", "Home ZSG 檢測", "Home追加運轉移動量"
    ];

    let currentMotorId = 0;

    // 取得 Jog&Home 參數
    function fetchJogHomeParams(motorId) {
        return fetch(`/Motor/GetJogHomeParams?motorId=${motorId}`)
            .then(res => res.json());
    }

    // 寫入單一參數
    function setJogHomeParam(motorId, idx, value) {
        return fetch('/Motor/SetJogHomeParam', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ motorId: motorId, index: idx, value: value })
        }).then(res => res.json());
    }

    // 寫入全部參數
    function saveJogHomeParams(motorId, params) {
        return fetch('/Motor/SaveJogHomeParams', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ motorId: motorId, values: params })
        }).then(res => res.json());
    }

    // 渲染表格
    function renderJogHomeTable(paramValues) {
        const tbody = document.querySelector('#jogHomeTable tbody');
        tbody.innerHTML = '';
        for (let i = 0; i < 16; i++) {
            const value = paramValues[i] ?? '';
            const paramName = jogHomeParamNames[i] ?? '';
            tbody.innerHTML += `
                <tr>
                    <td>${i + 1}</td>
                    <td>${paramName}</td>
                    <td class="current-value" data-idx="${i}">${value}</td>
                    <td>
                        <input type="text" class="write-value" data-idx="${i}" value="${value}">
                    </td>
                    <td>
                        <button type="button" class="set-btn" data-idx="${i}">設定</button>
                    </td>
                </tr>
            `;
        }
        // 設定按鈕事件
        document.querySelectorAll('.set-btn').forEach(btn => {
            btn.onclick = function() {
                const idx = btn.getAttribute('data-idx');
                const input = document.querySelector(`.write-value[data-idx="${idx}"]`);
                // 立即更新第3欄
                document.querySelector(`.current-value[data-idx="${idx}"]`).textContent = input.value;
                // 同步送出到後端
                setJogHomeParam(currentMotorId, idx, input.value).then(() => {
                    // 可選：如需與後端同步，重新取得資料
                    // fetchJogHomeParams(currentMotorId).then(data => renderJogHomeTable(data));
                });
            };
        });
    }

    // Radio Button 事件
    document.querySelectorAll('input[name="motorRadio"]').forEach(radio => {
        radio.onchange = function() {
            currentMotorId = parseInt(this.value);
            fetchJogHomeParams(currentMotorId).then(data => renderJogHomeTable(data));
        };
    });

    // Refresh 按鈕
    document.getElementById('jogHomeRefreshBtn').onclick = function() {
        fetchJogHomeParams(currentMotorId).then(data => renderJogHomeTable(data));
    };

    // Save 按鈕
    document.getElementById('jogHomeSaveBtn').onclick = function() {
        const params = [];
        document.querySelectorAll('.write-value').forEach(input => {
            params.push(input.value);
        });
        saveJogHomeParams(currentMotorId, params).then(() => {
            fetchJogHomeParams(currentMotorId).then(data => renderJogHomeTable(data));
        });
    };

    // 頁面載入時自動載入
    fetchJogHomeParams(currentMotorId).then(data => renderJogHomeTable(data));
</script>

<script>
    let posVelCurrentMotorId = 0;

    function fetchPosVelData(motorId) {
        return fetch(`/Motor/GetPosVelData?motorId=${motorId}`)
            .then(res => res.json());
    }

    function renderPosVelTable(data) {
        const tbody = document.querySelector('#posVelTable tbody');
        tbody.innerHTML = '';
        for (let i = 0; i < 20; i++) {
            const opData = data && data[i] ? data[i] : { opType: '', position: '', velocity: '' };
            tbody.innerHTML += `
                <tr>
                    <td>${i}</td>
                    <td>${opData.opType ?? ''}</td>
                    <td class="pos-value">${opData.position ?? ''}</td>
                    <td>
                        <input type="text" class="form-control pos-input" value="${opData.position ?? ''}" data-index="${i}" />
                    </td>
                    <td>
                        <button type="button" class="set-pos-btn" data-index="${i}">設定</button>
                    </td>
                    <td class="vel-value">${opData.velocity ?? ''}</td>
                    <td>
                        <input type="text" class="form-control vel-input" value="${opData.velocity ?? ''}" data-index="${i}" />
                    </td>
                    <td>
                        <button type="button" class="set-vel-btn" data-index="${i}">設定</button>
                    </td>
                </tr>
            `;
        }

        // 綁定位置設定按鈕
        tbody.querySelectorAll('.set-pos-btn').forEach(btn => {
            btn.onclick = function() {
                const idx = btn.getAttribute('data-index');
                const input = tbody.querySelector(`.pos-input[data-index="${idx}"]`);
                const value = input.value;
                tbody.querySelectorAll('tr')[idx].querySelector('.pos-value').textContent = value;
                savePosVelData(posVelCurrentMotorId, idx, 'position', value);
            };
        });

        // 綁定速度設定按鈕
        tbody.querySelectorAll('.set-vel-btn').forEach(btn => {
            btn.onclick = function() {
                const idx = btn.getAttribute('data-index');
                const input = tbody.querySelector(`.vel-input[data-index="${idx}"]`);
                const value = input.value;
                tbody.querySelectorAll('tr')[idx].querySelector('.vel-value').textContent = value;
                savePosVelData(posVelCurrentMotorId, idx, 'velocity', value);
            };
        });
    }

    function savePosVelData(motorId, index, type, value) {
        fetch('/Motor/SetPosVelData', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ motorId, index, type, value })
        });
    }

    // Radio Button 事件
        document.querySelectorAll('input[name="posVelMotorRadio"]').forEach(radio => {
        radio.onchange = function() {
            posVelCurrentMotorId = parseInt(this.value);
            fetchPosVelData(posVelCurrentMotorId).then(data => renderPosVelTable(data));
        };
    });

    // Refresh 按鈕事件
    document.getElementById('posVelRefreshBtn').onclick = function() {
        fetchPosVelData(posVelCurrentMotorId).then(data => renderPosVelTable(data));
    };

	// Save 按鈕事件（儲存所有數據的值）
    document.getElementById('posVelSaveBtn').onclick = function() {
    const rows = document.querySelectorAll('#posVelTable tbody tr');
    const opDataList = [];
    rows.forEach((tr, i) => {
        const posInput = tr.querySelector('input.pos-input');
        const velInput = tr.querySelector('input.vel-input');
        opDataList.push({
            index: i,
            position: posInput ? posInput.value : '',
            velocity: velInput ? velInput.value : ''
        });
    });
    fetch('/Motor/SavePosVelData', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            motorId: posVelCurrentMotorId,
            opDataList: opDataList
        })
    }).then(res => res.json())
        .then(data => {
            // 可選：顯示提示訊息
            if(data.success) alert('儲存成功');
        });
    };

    // 頁面載入時自動載入
    fetchPosVelData(posVelCurrentMotorId).then(data => renderPosVelTable(data));
</script>

<script>

    document.getElementById('servoOnBtn').onclick = function() {
        fetch('/Motor/SetAllServoOn', { method: 'POST' });
    };
    document.getElementById('servoOffBtn').onclick = function() {
        fetch('/Motor/SetAllServoOff', { method: 'POST' });
    };
    document.getElementById('allStopBtn').onclick = function() {
        fetch('/Motor/AllStop', { method: 'POST' });
    };

    function updateTestProcedureStatus() {
        fetch('/Motor/GetTestProcedureStatus')
            .then(res => res.json())
            .then(data => {
                const el = document.getElementById('testProcedureStatus');
                if (el) {
                    el.textContent = data.isRunning ? '是' : '否';
                    el.style.color = data.isRunning ? '#28a745' : '#dc3545';
                }
            });
    }


    document.getElementById('startTestProcedureBtn').onclick = function() {
        fetch('/Motor/StartTestProcedure1', { method: 'POST' });
    };

    document.getElementById('stopTestProcedureBtn').onclick = function() {
        fetch('/Motor/StopTestProcedure', { method: 'POST' });
    };

    document.getElementById('startHomeProcedureBtn').onclick = function() {
        // 先取得流程執行狀態
        fetch('/Motor/GetRobotProcedureStatus')
            .then(res => res.json())
            .then(data => {
                if (data.isProcedureRunning) {
                    alert('系統已在執行流程，請勿重複啟動！');
                    return;
                }
                // 未執行流程才觸發原點復歸
                fetch('/Motor/StartHomeProcedure', { method: 'POST' })
                    .then(res => res.json())
                    .then(result => {
                        if (result.success) {
                            alert('原點復歸程序已啟動');
                        } else {
                            alert('啟動失敗');
                        }
                    });
            });
    };

        // ChargerControlApp\Views\Motor\Index.cshtml 片段
    document.getElementById('stopProcedureBtn').onclick = function() {
        fetch('/Motor/StopProcedure', { method: 'POST' });
    };

    document.getElementById('clearErrorBtn').onclick = function() {
        fetch('/Motor/ClearLastError', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // 清空畫面顯示
                    document.getElementById('errorCode').textContent = '0';
                    document.getElementById('errorMessage').textContent = '';
                }
            });
    };

    document.getElementById('startRotateProcedureBtn').onclick = function() {
        const targetPosNo = document.getElementById('rTargetCombo').value;
        fetch('/Motor/StartRotateProcedure', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ targetPosNo: parseInt(targetPosNo, 10) })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('旋轉動作流程已啟動');
            } else {
                alert('啟動失敗');
            }
        });
    };

    document.getElementById('startTakeCarBatteryProcedureBtn').onclick = function() {
        fetch('/Motor/StartTakeCarBatteryProcedure', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('從車輛取電池程序已啟動');
                } else {
                    alert('啟動失敗');
                }
            });
    };

    document.getElementById('startPlaceCarBatteryProcedureBtn').onclick = function() {
        fetch('/Motor/StartPlaceCarBatteryProcedure', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('電池放置到車輛程序已啟動');
                } else {
                    alert('啟動失敗');
                }
            });
    };

    // 放置到Slot
    document.getElementById('startPlaceSlotBatteryProcedureBtn').onclick = function() {
        const slotNo = parseInt(document.getElementById('slotNoInput').value, 10);
        fetch('/Motor/StartPlaceSlotBatteryProcedure', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ slotNo })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) alert('電池放置到Slot程序已啟動');
            else alert('啟動失敗');
        });
    };

    // 取出Slot
    document.getElementById('startTakeSlotBatteryProcedureBtn').onclick = function() {
        const slotNo = parseInt(document.getElementById('slotNoInputTake').value, 10);
        fetch('/Motor/StartTakeSlotBatteryProcedure', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ slotNo })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) alert('從Slot取出電池程序已啟動');
            else alert('啟動失敗');
        });
    };

    // 狀態輪詢
    function updateRobotProcedureStatus() {
        fetch('/Motor/GetRobotProcedureStatus')
            .then(res => {
                if (!res.ok) throw new Error('API error');
                return res.json();
            })
            .then(data => {
                const runningEl = document.getElementById('procedureRunningStatus');
                runningEl.textContent = data.isProcedureRunning ? '執行中' : '已停止';
                runningEl.style.color = data.isProcedureRunning ? '#28a745' : '#dc3545';

                const homeEl = document.getElementById('homeFinishedStatus');
                homeEl.textContent = data.isHomeFinished ? '已原點復歸完成' : '尚未完成原點復歸';
                homeEl.style.color = data.isHomeFinished ? '#28a745' : '#dc3545';

                const caseEl = document.getElementById('homeProcedureCaseStatus');
                caseEl.textContent = `程序編號：${data.homeProcedureCase ?? '-'}`;

                // 錯誤碼
                const errorCodeEl = document.getElementById('errorCode');
                errorCodeEl.textContent = data.errorCode ?? '-';

                // 錯誤訊息
                const errorMsgEl = document.getElementById('errorMessage');
                errorMsgEl.textContent = data.errorMessage ?? '';

                // 流程狀態訊息
                const procedureStatusEl = document.getElementById('procedureStatusArea');
                procedureStatusEl.textContent = data.procedureStatusMessage ?? '';

                // 旋轉軸 移動允許 訊息
                const rotateAxesCanMoveMessageEl = document.getElementById('rotateAxesCanMoveMessage');
                rotateAxesCanMoveMessageEl.textContent = data.rotateAxesCanMoveMessage ?? '';

                // Y軸 移動允許 訊息
                const yAxesCanMoveMessageEl = document.getElementById('yAxesCanMoveMessage');
                yAxesCanMoveMessageEl.textContent = data.yAxesCanMoveMessage ?? '';

                // Z軸 移動允許 訊息
                const zAxesCanMoveMessageEl = document.getElementById('zAxesCanMoveMessage');
                zAxesCanMoveMessageEl.textContent = data.zAxesCanMoveMessage ?? '';
            })
            .catch(() => {
                document.getElementById('procedureRunningStatus').textContent = '取得失敗';
                document.getElementById('homeFinishedStatus').textContent = '取得失敗';
                document.getElementById('homeProcedureCaseStatus').textContent = '程序編號：取得失敗';
                document.getElementById('errorCode').textContent = '-';
                document.getElementById('errorMessage').textContent = '取得失敗';
                document.getElementById('procedureStatusArea').textContent = '取得失敗';
                document.getElementById('rotateAxesCanMoveMessage').textContent = '取得失敗';
                document.getElementById('yAxesCanMoveMessage').textContent = '取得失敗';
                document.getElementById('zAxesCanMoveMessage').textContent = '取得失敗';
            });
    }
    setInterval(updateRobotProcedureStatus, 1000);
    updateRobotProcedureStatus();

    setInterval(updateTestProcedureStatus, 1000);
    updateTestProcedureStatus();

</script>