@{
    ViewData["Title"] = "Charger";
    var chargers = ViewBag.Chargers as ChargerControlApp.Hardware.NPB450Controller[];
}
<div class="text-center">
    <h1 class="display-4">電源供應器狀態</h1>
    <div class="mb-3">
        <span>目前使用的數量: @ViewBag.NPB450ControllerInstnaceNumber</span>
    </div>
    <div class="charger-box-grid mb-4">
        @for (int i = 0; i < 8; i++)
        {
            var isUsed = chargers != null && i < chargers.Length && chargers[i].IsUsed;
            var boxClass = isUsed ? "charger-box charger-box-used" : "charger-box";
            <div class="@boxClass">
                <div>
                    <strong>Charger @(i + 1)</strong>
                </div>
                <div>
                    CANID: @(chargers != null && i < chargers.Length ? chargers[i].deviceCanID.ToString("X") : "-")
                </div>
                <div class="charger-btn-group">
                    <button type="button" class="btn btn-success" onclick="startCharging(@(chargers != null && i < chargers.Length ? chargers[i].deviceID : -1))">Charging Start</button>
                    <button type="button" class="btn btn-danger" onclick="stopCharging(@(chargers != null && i < chargers.Length ? chargers[i].deviceID : -1))">Charging Stop</button>
                </div>
                <!-- 顯示最後按下的按鈕 -->
                <div id="chargerLastPressed-@(chargers != null && i < chargers.Length ? chargers[i].deviceID : i)" class="charger-last-pressed" style="margin-top:6px; font-weight:600;">-</div>
                <!-- 分隔線放這裡 -->
                <hr class="card-divider" />
                <div id="chargerStatus-@(chargers != null && i < chargers.Length ? chargers[i].deviceID : i)" class="charger-status text-start">
                    <p>載入中...</p>
                </div>
                <hr />
            </div>
        }
    </div>
</div>
<script>

    function startCharging(id) {
        fetch('/Charger/StartCharging', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id }) // 傳送物件
        });
    }

    function stopCharging(id) {
        fetch('/Charger/StopCharging', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id })
        });
    }

    function updateChargerStatus(id) {
        fetch('/Charger/GetChargerStatus?id=' + id)
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('chargerStatus-' + id);
                const lastPressedDiv = document.getElementById('chargerLastPressed-' + id);
                if (statusDiv) {
                    // safe parsing for numeric values; fallback to raw value when not a number
                    const voltageStr = (!isNaN(parseFloat(data.voltage))) ? parseFloat(data.voltage).toFixed(3) : data.voltage;
                    const currentStr = (!isNaN(parseFloat(data.current))) ? parseFloat(data.current).toFixed(3) : data.current;
                    const socStr = (!isNaN(parseFloat(data.soc))) ? parseFloat(data.soc).toFixed(2) : data.soc;

                    statusDiv.innerHTML =
                        `<div class="section-title"><strong>數值</strong></div>
                         <div class="section-title" style="margin-bottom:4px;">
                            電壓: ${voltageStr}&nbsp;&nbsp;電流: ${currentStr}
                         </div>
                         <div class="section-title" style="margin-top:4px;">
                            <strong>SOC: ${socStr} %</strong>
                         </div>
                         <div class="section-title" style="margin-top:10px;">狀態</div>
                         <div class="charger-lights-row">
                            <span class="charger-status-light" style="background-color:${data.battery_exist ? 'lime' : 'white'};"></span>
                            <span>電池</span>
                            <span class="charger-status-light" style="background-color:${data.full_charged ? 'lime' : 'white'}; margin-left:18px;"></span>
                            <span>充飽</span>
                            <span class="charger-status-light" style="background-color:${data.ischarging ? 'lime' : 'white'}; margin-left:18px;"></span>
                            <span>充電中</span>
                         </div>
                         <div class="section-title" style="margin-top:10px;">IO</div>
                         <!-- 第一排燈號 -->
                         <div class="charger-lights-row">
                            <span class="charger-status-light" style="background-color:${data.fullm ? 'lime' : 'white'};"></span>
                            <span>FULLM</span>
                            <span class="charger-status-light" style="background-color:${data.ccm ? 'lime' : 'white'}; margin-left:18px;"></span>
                            <span>CCM</span>
                            <span class="charger-status-light" style="background-color:${data.cvm ? 'lime' : 'white'}; margin-left:18px;"></span>
                            <span>CVM</span>
                         </div>
                         <!-- 第二排燈號 -->
                         <div class="charger-lights-row" style="margin-top:6px;">
                            <span class="charger-status-light" style="background-color:${data.fvm ? 'lime' : 'white'};"></span>
                            <span>FVM</span>
                            <span class="charger-status-light" style="background-color:${data.wakeup_stop ? 'lime' : 'white'}; margin-left:18px;"></span>
                            <span>WAKEUP_STOP</span>
                         </div>
                         <!-- 第三排燈號 -->
                         <div class="charger-lights-row" style="margin-top:6px;">
                            <span class="charger-status-light" style="background-color:${data.ntcer ? 'lime' : 'white'};"></span>
                            <span>NTCER</span>
                            <span class="charger-status-light" style="background-color:${data.btnc ? 'lime' : 'white'}; margin-left:18px;"></span>
                            <span>BTNC</span>
                            <span class="charger-status-light" style="background-color:${data.cctof ? 'lime' : 'white'}; margin-left:18px;"></span>
                            <span>CCTOF</span>
                         </div>
                         <!-- 第四排燈號 -->
                         <div class="charger-lights-row" style="margin-top:6px;">
                            <span class="charger-status-light" style="background-color:${data.cvtof ? 'lime' : 'white'};"></span>
                            <span>CVTOF</span>
                            <span class="charger-status-light" style="background-color:${data.fvtof ? 'lime' : 'white'}; margin-left:18px;"></span>
                            <span>FVTOF</span>
                         </div>
                        <div class="section-title" style="margin-top:14px;">錯誤訊號</div>
                        <div class="charger-lights-row">
                            <span class="charger-status-light" style="background-color:${data.otp ? 'red' : 'white'};"></span>
                            <span>OTP</span>
                            <span class="charger-status-light" style="background-color:${data.ovp ? 'red' : 'white'}; margin-left:18px;"></span>
                            <span>OVP</span>
                            <span class="charger-status-light" style="background-color:${data.olp ? 'red' : 'white'}; margin-left:18px;"></span>
                            <span>OLP</span>
                        </div>
                        <!-- 第一列：SHORT, AC_FAIL -->
                        <div class="charger-lights-row" style="margin-top:6px;">
                            <span class="charger-status-light" style="background-color:${data.short ? 'red' : 'white'};"></span>
                            <span>SHORT</span>
                            <span class="charger-status-light" style="background-color:${data.ac_fail ? 'red' : 'white'}; margin-left:18px;"></span>
                            <span>AC_FAIL</span>
                        </div>
                        <!-- 第二列：OP_OFF, HI_TEMP -->
                        <div class="charger-lights-row" style="margin-top:6px;">
                            <span class="charger-status-light" style="background-color:${data.op_off ? 'red' : 'white'};"></span>
                            <span>OP_OFF</span>
                            <span class="charger-status-light" style="background-color:${data.hi_temp ? 'red' : 'white'}; margin-left:18px;"></span>
                            <span>HI_TEMP</span>
                        </div>
                        `;
                }

                if (lastPressedDiv) {
                    let last = '-';
                    if (data.final_start_trigger) last = '最後按下：開始充電';
                    else if (data.final_stop_trigger) last = '最後按下：停止充電';
                    lastPressedDiv.textContent = last;
                }
            });
    }

    // 取得所有 charger 的 id
    const chargerIds = [];
    @{
        if (chargers != null)
        {
            for (int i = 0; i < chargers.Length; i++)
            {
                @:chargerIds.push(@chargers[i].deviceID);
            }
        }
    }

    // 定期更新所有 charger 狀態
    setInterval(function() {
        chargerIds.forEach(function(id) {
            updateChargerStatus(id);
        });
    }, 1000); // 每1秒更新


</script>
