@{
    ViewData["Title"] = "System";
}

<ul class="nav nav-tabs" id="systemTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="version-tab" data-bs-toggle="tab" data-bs-target="#version" type="button" role="tab">Version</button>
    </li>

    <li class="nav-item" role="presentation">
        <button class="nav-link" id="canbus-tab" data-bs-toggle="tab" data-bs-target="#canbus" type="button" role="tab">CANBus</button>
    </li>

    <li class="nav-item" role="presentation">
        <button class="nav-link" id="modbus-tab" data-bs-toggle="tab" data-bs-target="#modbus" type="button" role="tab">Modbus</button>
    </li>

    <li class="nav-item" role="presentation">
        <button class="nav-link" id="parameter-tab" data-bs-toggle="tab" data-bs-target="#parameter" type="button" role="tab">Parameter</button>
    </li>
</ul>

<div class="tab-content mt-3" id="systemTabContent">
    <div class="tab-pane fade show active" id="version" role="tabpanel">
        <h4>System Version Information</h4>

        <div class="mb-3">
            <div class="d-flex align-items-center gap-2">
                <button id="btn-restart-service" class="btn btn-sm btn-warning">Restart App Service</button>
                <input id="service-name-input" class="form-control form-control-sm" style="width:300px;" value="chargercontrolapp.service" />
                <button id="btn-reboot-host" class="btn btn-sm btn-danger">Reboot Host</button>
                <button id="btn-shutdown-host" class="btn btn-sm btn-dark">Shutdown Host</button>
                <span id="system-action-feedback" class="small text-muted"></span>
            </div>
            <div class="mt-1 small text-muted">
                注意：執行需適當權限（Linux: root 或 sudoers；Windows: 管理員）。若沒有權限指令會失敗。
            </div>
        </div>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Component</th>
                    <th>Version</th>
                </tr>
            </thead>
            <tbody>
                @model Dictionary<string,string>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@item.Key</td>
                        <td>@item.Value</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="tab-pane fade" id="canbus" role="tabpanel">
        <h4>CANBus Status</h4>
        <div class="row">
            <div class="col-md-4">
                <div class="card border-secondary mb-3">
                    <div class="card-header">電源供應器設備與連線</div>
                    <div class="card-body text-secondary">
                        <dl class="row mb-0">
                            <dt class="col-6">設備最大數量</dt>
                            <dd class="col-6"><span id="can-device-max-count">-</span></dd>

                            <dt class="col-6">設備使用數量</dt>
                            <dd class="col-6"><span id="can-device-count">-</span></dd>

                            <dt class="col-6">現在連線數量</dt>
                            <dd class="col-6"><span id="can-connected-count">-</span></dd>
                        </dl>

                        <hr />

                        <div id="can-device-cycles" class="small">
                            <em>載入中…</em>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="modbus" role="tabpanel">
        <h4>Modbus Status</h4>
        <div class="row">
            <div class="col-md-4">
                <div class="card border-secondary mb-3">
                    <div class="card-header">Modbus連線狀況</div>
                    <div class="card-body text-secondary">
                        <dl class="row mb-0">
                            <dt class="col-6">Modbus讀取時間(ms)：</dt>
                            <dd class="col-6"><span id="modbus-read-time">-</span></dd>

                            <dt class="col-6">Modbus間隔時間(ms)：</dt>
                            <dd class="col-6"><span id="modbus-interval-time">-</span></dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="parameter" role="tabpanel">
        <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="d-flex align-items-center">
                <button id="btn-open-appsetting" class="btn btn-sm btn-outline-primary me-2" type="button">Open</button>
                <h4 class="mb-0">Parameter</h4>
            </div>

            <div>
                <!-- 保留右側 Load / Save 按鈕（分項顯示與儲存）-->
                <button id="btn-load-appsettings" class="btn btn-sm btn-outline-primary me-2" type="button">Load</button>
                <button id="btn-save-appsettings" class="btn btn-sm btn-primary" type="button">Save</button>
            </div>
        </div>

        <div class="mt-1 mb-3">
            <small>appsettings.json 路徑： <code id="appsettings-path">@ViewData["AppSettingsPath"]</code></small>
        </div>

        <!-- Raw JSON 編輯 modal（Open）-->
        <div class="modal fade" id="appsettingsModal" tabindex="-1" aria-labelledby="appsettingsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="appsettingsModalLabel">appsettings.json 編輯（Raw）</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <textarea id="appsettings-content" class="form-control" rows="20" spellcheck="false" style="font-family: monospace;"></textarea>
                        <div id="appsettings-feedback" class="mt-2 text-muted small"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="modal-save-btn" class="btn btn-primary">Save (Raw)</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 分項顯示表單（Load / Save） -->
        <div id="appsettings-form" class="mb-4" style="display:none;">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">ServerIp</label>
                    <input id="fld-ServerIp" class="form-control" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">DeviceId</label>
                    <input id="fld-DeviceId" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label class="form-label">IPPort</label>
                    <input id="fld-IPPort" class="form-control" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">DeviceModel</label>
                    <input id="fld-DeviceModel" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label class="form-label">DeviceInfo</label>
                    <input id="fld-DeviceInfo" class="form-control" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">TagName</label>
                    <input id="fld-TagName" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label class="form-label">DeviceName</label>
                    <input id="fld-DeviceName" class="form-control" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">ChargingStationName</label>
                    <input id="fld-ChargingStationName" class="form-control" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">MaxChargingCurrent</label>
                    <input id="fld-MaxChargingCurrent" type="number" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">CanBitrate</label>
                    <input id="fld-CanBitrate" type="number" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">PowerSupplyInstanceNumber</label>
                    <input id="fld-PowerSupplyInstanceNumber" type="number" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">PositionInPosOffset</label>
                    <input id="fld-PositionInPosOffset" type="number" class="form-control" />
                </div>

                <div class="col-md-4">
                    <label class="form-label">CanInterface</label>
                    <input id="fld-CanInterface" class="form-control" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">PortName</label>
                    <input id="fld-PortName" class="form-control" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">PortNameLinux</label>
                    <input id="fld-PortNameLinux" class="form-control" />
                </div>

                <div class="col-md-3">
                    <div class="form-check mt-3">
                        <input id="fld-SensorCheckPass" class="form-check-input" type="checkbox" />
                        <label class="form-check-label">SensorCheckPass</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-check mt-3">
                        <input id="fld-ServoOnAndHomeAfterStartup" class="form-check-input" type="checkbox" />
                        <label class="form-check-label">ServoOnAndHomeAfterStartup</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-check mt-3">
                        <input id="fld-ChargerUseAsync" class="form-check-input" type="checkbox" />
                        <label class="form-check-label">ChargerUseAsync</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-check mt-3">
                        <input id="fld-GRPCRegisterOnlyResponse" class="form-check-input" type="checkbox" />
                        <label class="form-check-label">GRPCRegisterOnlyResponse</label>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-check mt-3">
                        <input id="fld-CheckBattaryExistByMemory" class="form-check-input" type="checkbox" />
                        <label class="form-check-label">CheckBattaryExistByMemory</label>
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label">CheckBatteryExistValue_Voltage_V</label>
                    <input id="fld-CheckBatteryExistValue_Voltage_V" type="number" step="0.01" class="form-control" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">CheckBatteryFullChargeValue_A</label>
                    <input id="fld-CheckBatteryFullChargeValue_A" type="number" step="0.01" class="form-control" />
                </div>

                <div class="col-md-4">
                    <label class="form-label">CheckBatteryChargeValue_Voltage_V</label>
                    <input id="fld-CheckBatteryChargeValue_Voltage_V" type="number" step="0.01" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label class="form-label">RechargeAfterFullDischarge_Minutes</label>
                    <input id="fld-RechargeAfterFullDischarge_Minutes" type="number" class="form-control" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">FullChargeCheckDelay_Seconds</label>
                    <input id="fld-FullChargeCheckDelay_Seconds" type="number" class="form-control" />
                </div>
            </div>

            <!-- HwVersions -->
            <div class="mt-4">
                <h6>HwVersions</h6>
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr><th>Name</th><th>Version</th><th>SerialNumber</th><th style="width:80px;"></th></tr>
                    </thead>
                    <tbody id="hwversions-body"></tbody>
                </table>
                <button id="btn-add-hw" class="btn btn-sm btn-outline-secondary">Add HW</button>
            </div>

            <!-- SwVersions -->
            <div class="mt-4">
                <h6>SwVersions</h6>
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr><th>Name</th><th>Version</th><th style="width:80px;"></th></tr>
                    </thead>
                    <tbody id="swversions-body"></tbody>
                </table>
                <button id="btn-add-sw" class="btn btn-sm btn-outline-secondary">Add SW</button>
            </div>

            <div class="mt-3">
                <div id="appsettings-message" class="text-muted small"></div>
            </div>
        </div>

    </div>
</div>


@section Scripts {
    <script>
        (function () {
            // --- existing periodic status updaters (unchanged) ---
            const canUrl = '/System/CanbusStatus';
            const deviceEl = document.getElementById('can-device-count');
            const connectedEl = document.getElementById('can-connected-count');
            const devicemaxEl = document.getElementById('can-device-max-count');
            const cyclesContainer = document.getElementById('can-device-cycles');

            function renderCycles(cycles) {
                if (!Array.isArray(cycles) || cycles.length === 0) {
                    cyclesContainer.innerHTML = '<em>無設備資料</em>';
                    return;
                }
                const rows = cycles.map(c => {
                    const enabledText = c.enabled ? '' : ' (未啟用)';
                    return `<div>設備[${c.index}] 讀取次數: ${c.cycleCount}${enabledText}</div>`;
                });
                cyclesContainer.innerHTML = rows.join('');
            }

            async function updateCanbusStatus() {
                try {
                    const res = await fetch(canUrl, { cache: 'no-store' });
                    if (!res.ok) throw new Error('Network response was not ok');
                    const json = await res.json();
                    deviceEl.textContent = json.deviceUseCount ?? '-';
                    connectedEl.textContent = json.connectedCount ?? '-';
                    devicemaxEl.textContent = json.deviceMaxCount ?? '-';
                    renderCycles(json.cycles);
                } catch (err) {
                    console.error('Failed to fetch CANBus status:', err);
                }
            }

            updateCanbusStatus();
            setInterval(updateCanbusStatus, 5000);

            const modbusUrl = '/System/ModbusStatus';
            const modbusReadEl = document.getElementById('modbus-read-time');
            const modbusIntervalEl = document.getElementById('modbus-interval-time');

            async function updateModbusStatus() {
                try {
                    const res = await fetch(modbusUrl, { cache: 'no-store' });
                    if (!res.ok) throw new Error('Network response was not ok');
                    const json = await res.json();
                    modbusReadEl.textContent = json.modbusReadTime ?? '-';
                    modbusIntervalEl.textContent = json.modbusActFreq ?? '-';
                } catch (err) {
                    console.error('Failed to fetch Modbus status:', err);
                }
            }

            updateModbusStatus();
            setInterval(updateModbusStatus, 5000);
        })();

        // --- Raw modal Open / Save (Open 按鈕) ---
        (function () {
            const openBtn = document.getElementById('btn-open-appsetting');
            const modalEl = document.getElementById('appsettingsModal');
            const modal = new bootstrap.Modal(modalEl);
            const textarea = document.getElementById('appsettings-content');
            const feedback = document.getElementById('appsettings-feedback');
            const modalSaveBtn = document.getElementById('modal-save-btn');

            async function openRaw() {
                feedback.textContent = '載入中…';
                try {
                    const res = await fetch('/System/GetAppSettings', { cache: 'no-store' });
                    if (!res.ok) {
                        const err = await res.json().catch(()=>null);
                        feedback.textContent = '載入失敗: ' + (err?.message ?? res.statusText);
                        return;
                    }
                    const text = await res.text();
                    textarea.value = text;
                    feedback.textContent = '已載入 raw JSON，可直接編輯並按 Save (Raw)';
                    modal.show();
                } catch (ex) {
                    feedback.textContent = '載入失敗: ' + ex.message;
                }
            }

            async function saveRaw() {
                feedback.textContent = '儲存中…';
                const raw = textarea.value;
                try {
                    JSON.parse(raw);
                } catch (ex) {
                    feedback.textContent = 'JSON 格式錯誤：' + ex.message;
                    return;
                }

                try {
                    const res = await fetch('/System/SaveAppSettings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: raw
                    });
                    if (!res.ok) {
                        const err = await res.json().catch(()=>null);
                        feedback.textContent = '儲存失敗: ' + (err?.message ?? res.statusText);
                        return;
                    }
                    feedback.textContent = '儲存成功';
                    setTimeout(() => modal.hide(), 700);
                } catch (ex) {
                    feedback.textContent = '儲存失敗: ' + ex.message;
                }
            }

            if (openBtn) openBtn.addEventListener('click', openRaw);
            if (modalSaveBtn) modalSaveBtn.addEventListener('click', saveRaw);
        })();

        // --- 分項 Load / Save（右側按鈕）---
        (function () {
            const btnLoad = document.getElementById('btn-load-appsettings');
            const btnSave = document.getElementById('btn-save-appsettings');
            const formDiv = document.getElementById('appsettings-form');
            const msgEl = document.getElementById('appsettings-message');
            const pathEl = document.getElementById('appsettings-path');

            let originalJson = null; // cache full JSON object loaded

            const fld = id => document.getElementById('fld-' + id);

            function setField(id, value) {
                const e = fld(id);
                if (!e) return;
                if (e.type === 'checkbox') e.checked = !!value;
                else e.value = value ?? '';
            }

            function getFieldValue(id) {
                const e = fld(id);
                if (!e) return null;
                if (e.type === 'checkbox') return e.checked;
                if (e.type === 'number') {
                    const v = e.value;
                    return v === '' ? null : Number(v);
                }
                return e.value;
            }

            function clearTable(bodyId) {
                document.getElementById(bodyId).innerHTML = '';
            }

            function addHwRow(hw) {
                const tbody = document.getElementById('hwversions-body');
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><input class="form-control form-control-sm hw-name" value="${(hw?.Name ?? '')}"></td>
                                <td><input class="form-control form-control-sm hw-version" value="${(hw?.Version ?? '')}"></td>
                                <td><input class="form-control form-control-sm hw-serial" value="${(hw?.SerialNumber ?? '')}"></td>
                                <td><button type="button" class="btn btn-sm btn-outline-danger btn-remove-hw">Del</button></td>`;
                tbody.appendChild(tr);
                tr.querySelector('.btn-remove-hw').addEventListener('click', () => tr.remove());
            }

            function addSwRow(sw) {
                const tbody = document.getElementById('swversions-body');
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><input class="form-control form-control-sm sw-name" value="${(sw?.Name ?? '')}"></td>
                                <td><input class="form-control form-control-sm sw-version" value="${(sw?.Version ?? '')}"></td>
                                <td><button type="button" class="btn btn-sm btn-outline-danger btn-remove-sw">Del</button></td>`;
                tbody.appendChild(tr);
                tr.querySelector('.btn-remove-sw').addEventListener('click', () => tr.remove());
            }

            document.getElementById('btn-add-hw').addEventListener('click', () => addHwRow({}));
            document.getElementById('btn-add-sw').addEventListener('click', () => addSwRow({}));

            function populateFromJson(json) {
                originalJson = json;
                const app = json?.AppSettings ?? {};
                const scalarIds = [
                    'ServerIp','DeviceId','IPPort','DeviceModel','DeviceInfo','TagName',
                    'DeviceName','ChargingStationName'
                ];
                scalarIds.forEach(id => setField(id, app[id]));

                setField('MaxChargingCurrent', app.MaxChargingCurrent);
                setField('CanBitrate', app.CanBitrate);
                setField('PowerSupplyInstanceNumber', app.PowerSupplyInstanceNumber);
                setField('PositionInPosOffset', app.PositionInPosOffset);
                setField('CanInterface', app.CanInterface);
                setField('PortName', app.PortName);
                setField('PortNameLinux', app.PortNameLinux);

                setField('SensorCheckPass', app.SensorCheckPass);
                setField('ServoOnAndHomeAfterStartup', app.ServoOnAndHomeAfterStartup);
                setField('ChargerUseAsync', app.ChargerUseAsync);
                setField('GRPCRegisterOnlyResponse', app.GRPCRegisterOnlyResponse);
                setField('CheckBattaryExistByMemory', app.CheckBattaryExistByMemory);

                setField('CheckBatteryExistValue_Voltage_V', app.CheckBatteryExistValue_Voltage_V);
                setField('CheckBatteryFullChargeValue_A', app.CheckBatteryFullChargeValue_A);
                setField('CheckBatteryChargeValue_Voltage_V', app.CheckBatteryChargeValue_Voltage_V);
                setField('RechargeAfterFullDischarge_Minutes', app.RechargeAfterFullDischarge_Minutes);
                setField('FullChargeCheckDelay_Seconds', app.FullChargeCheckDelay_Seconds);

                clearTable('hwversions-body');
                const hws = app.HwVersions ?? [];
                if (hws.length === 0) addHwRow({});
                else hws.forEach(h => addHwRow(h));

                clearTable('swversions-body');
                const sws = app.SwVersions ?? [];
                if (sws.length === 0) addSwRow({});
                else sws.forEach(s => addSwRow(s));

                formDiv.style.display = '';
                msgEl.textContent = '已載入設定，請修改後按 Save 儲存（儲存會覆寫 AppSettings 區塊）';

                // --- 新增：為每個欄位套用 label tooltip（輸入框/選取框本身不設 tooltip） ---
                (function initFieldTooltips() {
                    const help = {
                        ServerIp: "上位系統位址，系統會向該上位系統註冊",
                        DeviceId: "設備ID",
                        IPPort: "設備本身的網路位址，給上位系統來使用gRPC來讀取設備狀態及下達命令",
                        DeviceModel: "設備型號",
                        DeviceInfo: "設備資訊",
                        TagName: "標籤",
                        DeviceName: "設備名稱",
                        ChargingStationName: "充電站名稱",
                        MaxChargingCurrent: "最大充電電流",
                        CanBitrate: "CANBus 通訊Baudrate",
                        PowerSupplyInstanceNumber: "使用電源供應器數量",
                        PositionInPosOffset: "判斷定位最大誤差，超過該數值會發生錯誤",
                        CanInterface: "CANBus 使用介面名稱",
                        PortName: "RS485介面名稱(Windows)",
                        PortNameLinux: "RS485介面名稱(Linux)",
                        CheckBattaryExistByMemory: "利用設定記憶來檢查電池存在",
                        ServoOnAndHomeAfterStartup: "系統開啟後會自動進行原點複歸",
                        ChargerUseAsync: "CANBus讀取使用非同步(目前無法使用)",
                        GRPCRegisterOnlyResponse: "gRPC註冊回應僅判斷DeviceName為非空值視為完成",
                        SensorCheckPass: "在流程中不使用感測器確認電池存在與否",
                        CheckBatteryExistValue_Voltage_V: "當電源供應器電壓超過該數值視為有電池存在",
                        CheckBatteryFullChargeValue_A: "當電源供應器電流低於該數值視為已經充飽電，會停止充電",
                        CheckBatteryChargeValue_Voltage_V: "充電判斷標準，當電壓超過該數值表示正在充電中",
                        RechargeAfterFullDischarge_Minutes: "當充飽電停止充電後，在經過該數值的時間後會重新充電",
                        FullChargeCheckDelay_Seconds: "重新充電後，經過該數值的時間後才會檢查是否充飽電"
                    };

                    Object.keys(help).forEach(key => {
                        const el = document.getElementById('fld-' + key);
                        if (!el) return;
                        const txt = help[key] || '';

                        // 只設定欄位名稱(label)的 title / tooltip；輸入框與 checkbox 本體不設 tooltip
                        try {
                            // same parent (most inputs): label.form-label exists
                            let lab = null;
                            const parent = el.parentElement;
                            if (parent) lab = parent.querySelector('.form-label, .form-check-label');
                            // fallback: look for any label element nearby
                            if (!lab) {
                                const possible = document.querySelectorAll('label');
                                for (const p of possible) {
                                    if (p.textContent && p.textContent.trim().startsWith(key)) { lab = p; break; }
                                }
                            }
                            if (lab) {
                                lab.setAttribute('title', txt);
                                if (window.bootstrap && bootstrap.Tooltip) {
                                    const inst = bootstrap.Tooltip.getInstance(lab);
                                    if (inst) inst.dispose();
                                    bootstrap.Tooltip.getOrCreateInstance(lab, { placement: 'top' });
                                }
                            }
                        } catch (e) {
                            console.error('set label title error', e);
                        }
                    });
                })();
            }

            function buildAppSettingsFromForm() {
                const app = {};
                const scalarIds = [
                    'ServerIp','DeviceId','IPPort','DeviceModel','DeviceInfo','TagName',
                    'DeviceName','ChargingStationName'
                ];
                scalarIds.forEach(id => { const v = getFieldValue(id); if (v !== null) app[id] = v; });

                const trySetNumber = (id, prop) => {
                    const v = getFieldValue(id);
                    if (v !== null && v !== '') app[prop] = Number(v);
                };

                trySetNumber('MaxChargingCurrent','MaxChargingCurrent');
                trySetNumber('CanBitrate','CanBitrate');
                trySetNumber('PowerSupplyInstanceNumber','PowerSupplyInstanceNumber');
                trySetNumber('PositionInPosOffset','PositionInPosOffset');

                app['CanInterface'] = getFieldValue('CanInterface') ?? '';
                app['PortName'] = getFieldValue('PortName') ?? '';
                app['PortNameLinux'] = getFieldValue('PortNameLinux') ?? '';

                app['SensorCheckPass'] = !!getFieldValue('SensorCheckPass');
                app['ServoOnAndHomeAfterStartup'] = !!getFieldValue('ServoOnAndHomeAfterStartup');
                app['ChargerUseAsync'] = !!getFieldValue('ChargerUseAsync');
                app['GRPCRegisterOnlyResponse'] = !!getFieldValue('GRPCRegisterOnlyResponse');
                app['CheckBattaryExistByMemory'] = !!getFieldValue('CheckBattaryExistByMemory');

                const numOrNull = (id) => {
                    const v = getFieldValue(id);
                    return (v === null || v === '') ? null : Number(v);
                };
                const v1 = numOrNull('CheckBatteryExistValue_Voltage_V');
                if (v1 !== null) app['CheckBatteryExistValue_Voltage_V'] = v1;
                const v2 = numOrNull('CheckBatteryFullChargeValue_A');
                if (v2 !== null) app['CheckBatteryFullChargeValue_A'] = v2;
                const vNew = numOrNull('CheckBatteryChargeValue_Voltage_V');
                if (vNew !== null) app['CheckBatteryChargeValue_Voltage_V'] = vNew;
                const v3 = numOrNull('RechargeAfterFullDischarge_Minutes');
                if (v3 !== null) app['RechargeAfterFullDischarge_Minutes'] = v3;
                const v4 = numOrNull('FullChargeCheckDelay_Seconds');
                if (v4 !== null) app['FullChargeCheckDelay_Seconds'] = v4;

                // read hwversions
                const hwRows = Array.from(document.querySelectorAll('#hwversions-body tr'));
                const hws = hwRows.map(tr => {
                    return {
                        Name: tr.querySelector('.hw-name')?.value ?? '',
                        Version: tr.querySelector('.hw-version')?.value ?? '',
                        SerialNumber: tr.querySelector('.hw-serial')?.value ?? ''
                    };
                }).filter(x => x.Name || x.Version || x.SerialNumber);
                app['HwVersions'] = hws;

                // read swversions
                const swRows = Array.from(document.querySelectorAll('#swversions-body tr'));
                const sws = swRows.map(tr => {
                    return {
                        Name: tr.querySelector('.sw-name')?.value ?? '',
                        Version: tr.querySelector('.sw-version')?.value ?? ''
                    };
                }).filter(x => x.Name || x.Version);
                app['SwVersions'] = sws;

                return app;
            }

            // Load handler (populate form)
            async function handleLoad() {
                msgEl.textContent = '載入中…';
                try {
                    const res = await fetch('/System/GetAppSettings', { cache: 'no-store' });
                    if (!res.ok) {
                        const err = await res.json().catch(()=>null);
                        msgEl.textContent = '載入失敗: ' + (err?.message ?? res.statusText);
                        return;
                    }
                    const text = await res.text();
                    let parsed = null;
                    try {
                        parsed = JSON.parse(text);
                    } catch (ex) {
                        msgEl.textContent = '解析 JSON 失敗：' + ex.message;
                        return;
                    }
                    pathEl.textContent = pathEl.textContent || '@ViewData["AppSettingsPath"]';
                    populateFromJson(parsed);
                } catch (ex) {
                    msgEl.textContent = '載入失敗: ' + ex.message;
                }
            }

            // Save handler (from form)
            async function handleSave() {
                if (!originalJson) {
                    msgEl.textContent = '尚未載入設定，請先按 Load';
                    return;
                }
                msgEl.textContent = '儲存中…';

                const newApp = buildAppSettingsFromForm();
                const payload = JSON.parse(JSON.stringify(originalJson));
                payload.AppSettings = newApp;

                try {
                    const res = await fetch('/System/SaveAppSettings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload, null, 2)
                    });
                    if (!res.ok) {
                        const err = await res.json().catch(()=>null);
                        msgEl.textContent = '儲存失敗: ' + (err?.message ?? res.statusText);
                        return;
                    }
                    msgEl.textContent = '儲存成功';
                    originalJson = payload;
                } catch (ex) {
                    msgEl.textContent = '儲存失敗: ' + ex.message;
                }
            }

            if (btnLoad) btnLoad.addEventListener('click', handleLoad);
            if (btnSave) btnSave.addEventListener('click', handleSave);
        })();

        // --- 新增：前端呼叫 SystemAction (restart service / reboot / shutdown) ---
        (function () {
            const btnRestart = document.getElementById('btn-restart-service');
            const btnReboot = document.getElementById('btn-reboot-host');
            const btnShutdown = document.getElementById('btn-shutdown-host');
            const svcInput = document.getElementById('service-name-input');
            const feedback = document.getElementById('system-action-feedback');

            async function postAction(action, serviceName) {
                feedback.textContent = '執行中…';
                try {
                    const body = { action: action, serviceName: serviceName };
                    const res = await fetch('/System/SystemAction', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    const json = await res.json().catch(()=>null);
                    if (!res.ok) {
                        feedback.textContent = '失敗: ' + (json?.message ?? res.statusText);
                        return;
                    }
                    feedback.textContent = '已送出指令: ' + (json?.message ?? 'ok');
                    if (action === 'reboot' || action === 'shutdown') {
                        setTimeout(()=>{ feedback.textContent = action === 'shutdown' ? '主機即將關機…' : '主機即將重啟…'; }, 500);
                    }
                } catch (ex) {
                    feedback.textContent = '例外: ' + ex.message;
                }
            }

            if (btnRestart) btnRestart.addEventListener('click', () => {
                const svc = svcInput.value || 'chargercontrolapp.service';
                if (!confirm(`確定要重新啟動 service: ${svc} ?`)) return;
                postAction('restart-service', svc);
            });

            if (btnReboot) btnReboot.addEventListener('click', () => {
                if (!confirm('確定要重開主機？（會中斷所有服務）')) return;
                postAction('reboot', '');
            });

            if (btnShutdown) btnShutdown.addEventListener('click', () => {
                if (!confirm('確定要關閉主機？（會中斷所有服務且關機）')) return;
                postAction('shutdown', '');
            });
        })();
    </script>
}
